
name: CI

on:
  push:
    branches: [main]

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"

      - name: Install dependencies
        run: bun install

      - name: Run unit tests
        run: bun run test
        continue-on-error: true

      - name: Install k6
        run: |
          curl -sL https://github.com/grafana/k6/releases/download/v0.52.0/k6-v0.52.0-linux-amd64.tar.gz | tar xvz
          sudo mv k6-v0.52.0-linux-amd64/k6 /usr/local/bin/
          k6 version

      - name: Start Docker services
        run: |
          docker compose -f docker-compose.dev.yml up -d
          echo "Waiting 2 minutes for services to start..."
          sleep 120

      - name: Check services
        run: |
          docker compose -f docker-compose.dev.yml ps
          curl http://localhost:3000/health || echo "Gateway not ready"
          curl http://localhost:3001/health/live || echo "Order service not ready"
          curl http://localhost:3002/health/live || echo "Inventory not ready"
          curl http://localhost:9000/health/live || echo "Auth not ready"

      - name: Run simple k6 test
        run: |
          cd scripts/load-test-k6
          k6 run -e BASE_URL=http://localhost:3000 scenarios/ci.js || echo "k6 test completed"
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.dev.yml down -v
